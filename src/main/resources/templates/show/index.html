<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.mx/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title>Liste des spectacles</title>
</head>
<body>
<div class="max-w-7xl mx-auto px-6 py-10">
    <div layout:fragment="content">

        <!-- Titre -->
        <div class="mb-6 flex items-end justify-between gap-4">
            <h1 class="text-4xl font-extrabold text-gray-900" th:text="${title}">Liste des spectacles</h1>
            <p th:if="${resultCount != null}" class="text-sm text-gray-600 italic">
                <span th:text="${resultCount}">0</span> résultat(s)
            </p>
        </div>

        <!-- Barre filtres/tri -->
        <form method="get" th:action="@{/shows}"
              class="mb-6 bg-white border border-gray-200 rounded-xl shadow-sm p-4 grid grid-cols-1 lg:grid-cols-12 gap-4">

            <!-- Mot-clé -->
            <div class="col-span-12 lg:col-span-3">
                <label for="tag" class="block text-sm font-semibold text-gray-800 mb-1">Mot-clé</label>
                <select id="tag" name="tag" class="w-full h-9 border rounded px-3 text-sm">
                    <option value="">-- Tous --</option>
                    <option th:each="t : ${availableTags}"
                            th:value="${t.tag}" th:text="${t.tag}"
                            th:selected="${param.tag} == ${t.tag}"></option>
                </select>
            </div>

            <!-- Prix plein (€) -->
            <div class="col-span-12 lg:col-span-4">
                <label class="block text-sm font-semibold text-gray-800 mb-1">Prix plein (€)</label>
                <div class="flex items-center gap-2">
                    <input id="minPrice" name="minPrice" type="text" inputmode="decimal"
                           pattern="[0-9]+([\\.,][0-9]+)?"
                           placeholder="Min" th:value="${filter_minPrice}"
                           class="h-9 w-28 border rounded px-2 text-sm"/>
                    <span class="text-gray-400">—</span>
                    <input id="maxPrice" name="maxPrice" type="text" inputmode="decimal"
                           pattern="[0-9]+([\\.,][0-9]+)?"
                           placeholder="Max" th:value="${filter_maxPrice}"
                           class="h-9 w-28 border rounded px-2 text-sm"/>
                </div>
            </div>

            <!-- Nombre de représentations -->
            <div class="col-span-12 lg:col-span-3">
                <label class="block text-sm font-semibold text-gray-800 mb-1">Nombre de représentations</label>
                <div class="flex items-center gap-2">
                    <input id="repMin" name="repMin" type="number" min="0" step="1"
                           placeholder="Min" th:value="${filter_repMin}"
                           class="h-9 w-28 border rounded px-2 text-sm"/>
                    <span class="text-gray-400">—</span>
                    <input id="repMax" name="repMax" type="number" min="0" step="1"
                           placeholder="Max" th:value="${filter_repMax}"
                           class="h-9 w-28 border rounded px-2 text-sm"/>
                </div>
            </div>

            <!-- Trier par -->
            <div class="col-span-12 lg:col-span-2">
                <label for="sort" class="block text-sm font-semibold text-gray-800 mb-1">Trier par</label>
                <select id="sort" name="sort" class="w-full h-9 border rounded px-2 text-sm">
                    <option value="title-asc" th:selected="${filter_sort}=='title-asc'">A → Z (Titre)</option>
                    <option value="title-desc" th:selected="${filter_sort}=='title-desc'">Z → A (Titre)</option>
                    <option value="price-asc" th:selected="${filter_sort}=='price-asc'">Prix plein : bas → haut</option>
                    <option value="price-desc" th:selected="${filter_sort}=='price-desc'">Prix plein : haut → bas</option>
                    <option value="rep-asc" th:selected="${filter_sort}=='rep-asc'">Représentations : croissant</option>
                    <option value="rep-desc" th:selected="${filter_sort}=='rep-desc'">Représentations : décroissant</option>
                </select>
            </div>

            <!-- Actions -->
            <div class="col-span-12 flex justify-end gap-2 pt-1">
                <a th:href="@{/shows}"
                   class="h-9 inline-flex items-center px-3 rounded border text-gray-700 hover:bg-gray-50 text-sm">
                    Réinitialiser
                </a>
                <button type="submit"
                        class="h-9 inline-flex items-center px-4 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm">
                    Appliquer
                </button>
            </div>
        </form>

        <!-- Grid -->
        <div th:if="${shows != null and !#lists.isEmpty(shows)}"
             class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

            <div th:each="show : ${shows}"
                 class="bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 overflow-hidden flex flex-col">

                <!-- Affiche -->
                <div class="h-48 bg-gray-100 flex items-center justify-center">
                    <img th:if="${show.posterUrl != null}"
                         th:src="@{'/images/' + ${show.posterUrl}}"
                         th:alt="${show.title}"
                         class="object-contain w-full h-full p-2"/>
                    <span th:unless="${show.posterUrl}" class="text-gray-400 italic text-sm">Pas d'image</span>
                </div>

                <!-- Infos -->
                <div class="p-4 flex-1 flex flex-col justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-1" th:text="${show.title}">Titre</h2>

                        <div class="flex flex-wrap items-center gap-2 text-sm mb-3">
                            <span th:if="${show.bookable}"
                                  class="inline-block px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                Réservable
                            </span>
                            <span th:unless="${show.bookable}"
                                  class="inline-block px-2 py-1 bg-red-100 text-red-600 rounded-full text-xs font-medium">
                                Non réservable
                            </span>

                            <!-- Prix plein -->
                            <span th:if="${fullPriceMap[show.id] != null}"
                                  class="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium"
                                  th:text="${#numbers.formatDecimal(fullPriceMap[show.id], 1, 'COMMA', 2, 'POINT')} + ' €'">9.99 €</span>
                            <span th:if="${fullPriceMap[show.id] == null}"
                                  class="text-gray-400 italic text-xs">Prix non défini</span>

                            <!-- Nb de reps -->
                            <span th:if="${repsCountMap[show.id] > 0}"
                                  class="inline-block px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium"
                                  th:text="${repsCountMap[show.id]} + ' représentations'">2 représentations</span>
                            <span th:if="${repsCountMap[show.id] == 0}"
                                  class="inline-block px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs font-medium italic">
                                Aucune représentation
                            </span>
                        </div>
                    </div>

                    <!-- Lien Détails – propage page + filtres + tri -->
                    <div class="mt-auto pt-3">
                        <a th:href="@{/shows/{id}(id=${show.id},
                           page=${currentPage},
                           tag=${param.tag},
                           minPrice=${filter_minPrice},
                           maxPrice=${filter_maxPrice},
                           repMin=${filter_repMin},
                           repMax=${filter_repMax},
                           sort=${filter_sort})}">
                            Voir les détails →
                        </a>

                    </div>
                </div>
            </div>
        </div>

        <!-- Aucun résultat -->
        <div th:if="${shows == null or #lists.isEmpty(shows)}"
             class="text-center text-gray-500 italic bg-white py-10 rounded shadow border mt-8 text-lg">
            Aucun spectacle n’a encore été enregistré.
        </div>

        <!-- Pagination -->
        <div th:if="${totalPages > 1}" class="flex justify-center items-center gap-2 mt-8">
            <a th:if="${currentPage > 0}"
               th:href="@{/shows(page=${currentPage-1},
                                tag=${param.tag},
                                minPrice=${filter_minPrice},
                                maxPrice=${filter_maxPrice},
                                repMin=${filter_repMin},
                                repMax=${filter_repMax},
                                sort=${filter_sort})}"
               class="px-3 py-1 rounded border bg-white hover:bg-gray-50">← Précédent</a>

            <div class="flex items-center gap-1">
                <span class="px-2 py-1 text-sm text-gray-700">
                    Page <span th:text="${currentPage+1}">1</span> / <span th:text="${totalPages}">1</span>
                </span>
            </div>

            <a th:if="${currentPage+1 < totalPages}"
               th:href="@{/shows(page=${currentPage+1},
                                tag=${param.tag},
                                minPrice=${filter_minPrice},
                                maxPrice=${filter_maxPrice},
                                repMin=${filter_repMin},
                                repMax=${filter_repMax},
                                sort=${filter_sort})}"
               class="px-3 py-1 rounded border bg-white hover:bg-gray-50">Suivant →</a>
        </div>

    </div>
</div>
</body>
</html>
