<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.mx/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/main}">
<head>
    <title th:text="${show.title}">Fiche d‚Äôun spectacle</title>
</head>
<body>
<div class="max-w-6xl mx-auto px-6 py-12">
    <div layout:fragment="content">

        <!-- Titre -->
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8" th:text="${show.title}">
            Titre du spectacle
        </h1>

        <!-- Affiche & Infos Principales -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <!-- Affiche -->
            <div>
                <div th:if="${show.posterUrl}" class="aspect-[2/3] bg-white rounded-lg shadow overflow-hidden">
                    <img th:src="@{'/images/' + ${show.posterUrl}}"
                         th:alt="${show.title}"
                         class="object-contain w-full h-full"/>
                </div>
                <div th:unless="${show.posterUrl}"
                     class="w-full aspect-[2/3] flex items-center justify-center bg-gray-100 text-gray-400 rounded-lg shadow">
                    Pas d‚Äôimage
                </div>
            </div>

            <!-- D√©tails -->
            <div class="md:col-span-2 space-y-6">
                <!-- Lieu -->
                <p th:if="${show.location}">
                    <span class="font-semibold text-gray-800">Lieu de cr√©ation :</span>
                    <span th:text="${show.location.designation}" class="text-gray-700">Lieu</span>
                </p>

                <!-- Description -->
                <div th:if="${show.description}" class="text-gray-700 leading-relaxed">
                    <h2 class="font-semibold text-gray-800 mb-2">Description</h2>
                    <p th:text="${show.description}">Texte du spectacle‚Ä¶</p>
                </div>

                <!-- Badges & Bouton -->
                <div class="flex flex-wrap items-center gap-4 mt-4">
                    <span th:if="${canBook}"
                          class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                        R√©servable
                    </span>
                    <span th:unless="${canBook}"
                          class="inline-block px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">
                        Non r√©servable
                    </span>

                    <!-- Prix plein -->
                    <span th:if="${computedFullPrice != null}"
                          class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"
                          th:text="${#numbers.formatDecimal(computedFullPrice, 1, 'COMMA', 2, 'POINT')} + ' ‚Ç¨'">
                        9.99 ‚Ç¨
                    </span>
                    <span th:if="${computedFullPrice == null}"
                          class="inline-block italic text-gray-400 text-sm">
                        Prix non d√©fini
                    </span>

                    <!-- Bouton principal R√©server -->
                    <div th:if="${canBook}" class="ml-auto">
                        <a th:href="@{/shows/{showId}/reserve(showId=${show.id})}"
                           class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition">
                            R√©server
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Repr√©sentations -->
        <section class="mb-12">
            <div class="flex items-end justify-between gap-4 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Repr√©sentations</h2>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                <div th:each="rep : ${show.representations}"
                     th:classappend="${rep.availableSeats > 0} ? 'bg-green-50' : 'bg-gray-200 text-gray-500'"
                     class="p-4 rounded-lg shadow flex flex-col">
                    <p class="font-medium mb-2"
                       th:text="${#temporals.format(rep.scheduledAt,'dd-MM-yyyy HH:mm')}">
                        12-10-2025 20:30
                    </p>
                    <p th:if="${rep.availableSeats > 0}"
                       class="mt-auto font-semibold text-gray-800"
                       th:text="${rep.availableSeats + ' place(s) dispo'}">
                        100 place(s) dispo
                    </p>
                    <p th:unless="${rep.availableSeats > 0}"
                       class="mt-auto italic">
                        Complet
                    </p>
                </div>
            </div>
        </section>

        <!-- Collaborateurs (affich√©s si fournis) -->
        <section class="mb-12" th:if="${collaborateurs}">
            <div class="flex items-end justify-between gap-4 mb-2">
                <h2 class="text-2xl font-bold text-gray-800">Collaborateurs</h2>
                <div class="flex items-center gap-2 text-sm">
                    <label for="collabSort" class="font-semibold">Trier les noms :</label>
                    <select id="collabSort" class="border rounded px-2 py-1">
                        <option value="asc">A ‚Üí Z</option>
                        <option value="desc">Z ‚Üí A</option>
                    </select>
                </div>
            </div>
            <div id="collabRoot" class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-700 text-sm">
                <div th:each="entry : ${collaborateurs}">
                    <h3 class="font-semibold mb-1" th:text="${entry.key}">R√¥le</h3>
                    <ul class="list-disc list-inside">
                        <li th:each="a : ${entry.value}"
                            class="collab-item"
                            th:text="${a.firstname + ' ' + a.lastname}">
                            Nom
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Mots-cl√©s & Formulaire d‚Äôajout (si fournis) -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Mots-cl√©s associ√©s</h2>
            <div class="flex flex-wrap gap-2 mb-4">
                <a th:each="tag : ${show.tags}"
                   th:href="@{/shows(tag=${tag.tag})}"
                   th:text="${tag.tag}"
                   class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium hover:bg-yellow-200">
                </a>
            </div>
            <p th:if="${show.tags == null or #lists.isEmpty(show.tags)}"
               class="italic text-gray-500 mb-4">
                Aucun mot-cl√©.
            </p>

            <div sec:authorize="hasRole('ADMIN')" class="mt-6">
                <form th:action="@{/shows/{id}/tags(id=${show.id})}"
                      method="post"
                      class="flex items-center space-x-2">
                    <select name="tagId"
                            required
                            class="border rounded px-2 py-1 text-sm">
                        <option value="" disabled selected>Ajouter un mot-cl√©</option>
                        <option th:each="t : ${availableTags}"
                                th:value="${t.id}"
                                th:text="${t.tag}"></option>
                    </select>
                    <button type="submit"
                            class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition">
                        Ajouter
                    </button>
                </form>
            </div>
        </section>

        <!-- Commentaires (si fournis) -->
        <section th:if="${reviews}">
            <div class="mb-12">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Commentaires</h2>

                <div th:if="${#lists.isEmpty(reviews)}" class="italic text-gray-500 mb-6">
                    Aucun commentaire pour ce spectacle pour l‚Äôinstant.
                </div>

                <div th:each="review : ${reviews}" class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <strong th:text="${review.user.login}" class="text-gray-800"></strong>
                            <span class="text-yellow-600 text-sm font-semibold ml-2" th:text="'‚≠ê ' + ${review.stars} + '/5'">‚≠ê 4/5</span>
                        </div>

                        <form th:if="${#authentication.name == review.user.login or #authorization.expression('hasRole(''ADMIN'')')}"
                              th:action="@{/reviews/delete}" method="post"
                              onsubmit="return confirm('Voulez-vous vraiment supprimer ce commentaire ?');">
                            <input type="hidden" name="reviewId" th:value="${review.id}" />
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="text-red-600 hover:text-red-800 text-lg ml-2" title="Supprimer">
                                üóëÔ∏è
                            </button>
                        </form>
                    </div>

                    <p class="text-gray-700 mb-2" th:text="${review.review}">Contenu du commentaire</p>
                    <small class="text-gray-400" th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy HH:mm')}">Date</small>
                </div>
            </div>
        </section>

        <!-- Retour ‚Äî propage page + filtres + tri -->
        <div class="mt-8">
            <a th:href="@{/shows(page=${page},
                                 tag=${tag},
                                 minPrice=${q_minPrice},
                                 maxPrice=${q_maxPrice},
                                 repMin=${q_repMin},
                                 repMax=${q_repMax},
                                 sort=${q_sort})}"
               class="text-blue-600 hover:underline">
                ‚Üê Retour √† la liste
            </a>
        </div>

    </div>
</div>


<script>
    (function(){
        const collabSort = document.getElementById('collabSort');
        if (!collabSort) return;
        function sortAllCollaborators(direction){
            document.querySelectorAll('#collabRoot ul').forEach(ul => {
                const items = Array.from(ul.querySelectorAll('.collab-item'));
                items.sort((a,b) => a.textContent.trim().localeCompare(b.textContent.trim(), 'fr', {sensitivity:'base'}));
                if (direction === 'desc') items.reverse();
                items.forEach(li => ul.appendChild(li));
            });
        }
        collabSort.addEventListener('change', () => sortAllCollaborators(collabSort.value));
        sortAllCollaborators(collabSort.value);
    })();
</script>
</body>
</html>
